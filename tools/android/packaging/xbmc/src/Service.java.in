package @APP_PACKAGE@;

import android.app.Notification;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.os.IBinder;
import android.util.Log;

public class Service extends android.app.Service
{
  private static final String TAG = "@APP_NAME@Service";

  native void _launchApplication();
  native static int _getStatus();

  public static int STATUS_STARTING = 1;
  public static int STATUS_UPGRADE_DB = 25;
  public static int STATUS_UPGRADE_ADDONS = 30;
  public static int STATUS_STARTED = 50;

  static private int m_status = 0;
  public static int getStatus()
  {
    if (m_status >= STATUS_STARTING)
      m_status = _getStatus();
    return m_status;
  }

  public static boolean isStarted()
  {
    return m_status >= STATUS_STARTED;
  }

  public Service()
  {
  }

  @Override
  public void onCreate()
  {
    Log.d(TAG, "onCreate: ");
    System.loadLibrary("@APP_NAME_LC@");
    super.onCreate();
  }

  @Override
  public int onStartCommand(Intent intent, int flags, int startId)
  {
    Log.d(TAG, "onStartCommand: ");
    if (m_status < STATUS_STARTED)
    {
      _launchApplication();
      m_status = STATUS_STARTING;
    }
    if (m_status >= STATUS_STARTED)
    {
      Intent i = new Intent("@APP_PACKAGE@.SERVICE_STARTED");
      sendBroadcast(i);
    }

    Bitmap icon = BitmapFactory.decodeResource(getResources(),
            R.drawable.ic_recommendation_80dp);

    Notification.Builder builder = new Notification.Builder(this)
            .setContentTitle(getString(R.string.app_name))
            .setContentText("@APP_NAME@ is running...")
            .setSmallIcon(R.drawable.notif_icon)
            .setLargeIcon(Bitmap.createScaledBitmap(icon, 128, 128, false))
            ;

    Notification notification = builder.build();
    startForeground(1, notification);
    return START_STICKY;
  }

  @Override
  public void onDestroy()
  {
    Log.d(TAG, "onDestroy: ");
    m_status = 0;

    Intent i = new Intent("@APP_PACKAGE@.SERVICE_STOPPED");
    sendBroadcast(i);

    super.onDestroy();
  }

  @Override
  public IBinder onBind(Intent intent)
  {
    // TODO: Return the communication channel to the service.
    throw new UnsupportedOperationException("Not implemented");
  }
}
